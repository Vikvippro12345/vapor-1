<!DOCTYPE html>
<!--

Okay, skids.

This is the frontend for VAPORyt. You'll find nothing of importance here.
The real magic is behind the backend, which is not public. Ha!

-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles/defaults.css" />
  <script src="/scripts/opt.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: transparent;
      font-family: 'Inter', Arial, sans-serif;
      color: var(--text-color);
    }
    body {
      display: flex; 
      flex-direction: column;
      align-items: center;
      padding: 30px 20px 50px 20px;
      min-height: 100vh;
      background-color: transparent;
    }
    .search-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 24px;
      width: 475px;
      max-width: 100%;
    }
    .search-input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 15px;
      background-color: rgba(255 255 255 / 0.15);
      border: none;
      font-size: 18px;
      outline: none;
      color: rgba(255 255 255 / 0.8);
      backdrop-filter: blur(10px);
      transition: width 0.2s ease;
      box-sizing: border-box;
    }
    .search-input:focus {
      width: 100%;
    }
    .search-input::placeholder {
      transition: opacity 0.2s ease;
      opacity: 1;
    }
    .search-input:focus::placeholder {
      opacity: 0;
    }
    .buttons-row {
      margin-top: 12px;
      display: flex;
      gap: 12px;
      width: 100%;
    }
    .api-button {
      flex: 1;
      padding: 12px 0;
      border-radius: 15px;
      background-color: rgba(255 255 255 / 0.15);
      border: none;
      font-size: 18px;
      color: rgba(255 255 255 / 0.8);
      backdrop-filter: blur(10px);
      cursor: pointer;
      font-family: 'Inter', Arial, sans-serif;
      font-weight: 500;
      transition: background-color 0.2s ease;
      user-select: none;
      text-align: center;
      box-sizing: border-box;
    }
    .api-button:hover,
    .api-button:focus {
      background-color: rgba(255 255 255 / 0.25);
      outline: none;
    }

    .results {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      max-width: 1000px;
      width: 100%;
      justify-items: stretch;
    }

    .video-card {
      cursor: pointer;
      width: 100%;
      background-color: transparent !important;
      border-radius: 15px;
      overflow: hidden;
      color: var(--text-color);
      font-weight: 500;
      user-select: none;
      transition: background-color 0.3s ease;
      display: flex;
      flex-direction: column;
      font-family: 'Inter', Arial, sans-serif;
      box-shadow: none !important;
      position: relative;
    }
    .video-card:hover {
      background-color: transparent !important;
    }
    
    .video-thumb-wrapper {
      position: relative;
      width: 100%;
      overflow: hidden;
      border-radius: 15px;
      aspect-ratio: 16 / 9;
    }
    
    .video-thumb {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 15px;
      object-fit: cover;
      user-select: none;
      transition: transform 0.15s ease;
      pointer-events: none;
    }
    .video-card:hover .video-thumb {
      transform: scale(1.05);
    }
    .video-title {
      padding: 8px 12px;
      font-weight: 500;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: left;
      user-select: text;
      background-color: transparent;
      border-radius: 0;
      margin: 0;
    }

    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.4);
      border-radius: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      z-index: 10;
    }
    /* WOW SO BEAUTIFUL */
    .spinner {
      width: 36px;
      height: 36px;
      border: 4px solid rgba(255 255 255 / 0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .overlay {
  position: fixed;
  inset: 0;
  background-color: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 40px;
  z-index: 9999;
  backdrop-filter: blur(6px);
  overflow-y: auto;
  overflow-x: hidden;
  box-sizing: border-box;
}

.overlay.hidden {
  display: none;
}

.overlay video {
  width: 90vw;
  max-width: 1100px;
  max-height: 75vh;
  border-radius: 15px;
  background-color: black;
  outline: none;
  margin-bottom: 20px;
  object-fit: contain;
  box-sizing: border-box;
}

.overlay .video-title,
.overlay .video-meta {
  width: 90vw;
  max-width: 1100px;
  color: var(--secondary-text-color);
  user-select: text;
  white-space: normal;
  overflow: visible;
  text-overflow: unset;
  text-align: left;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

.overlay .video-title {
  font-weight: 600;
  font-size: 1.6rem;
  line-height: 1.5;
  margin-bottom: 8px;
}

.overlay .video-meta {
  font-weight: 500;
  font-size: 1rem;
  line-height: 1.5;
  margin-bottom: 16px;
}


  </style>
</head>
<body>

<div class="search-container">
  <input
    type="search"
    class="search-input"
    id="searchInput"
    placeholder="Search YouTube videos..."
    autocomplete="off"
    spellcheck="false"
  />
  <div class="buttons-row" role="group" aria-label="API endpoint selectors">
    <button class="api-button" data-endpoint="clipto" type="button">alpha</button>
    <button class="api-button" data-endpoint="slicetube" type="button">bravo</button>
    <button class="api-button" data-endpoint="vidfly" type="button">charlie</button>
    <button class="api-button" data-endpoint="ssvid" type="button">delta</button>
  </div>
</div>

<div class="results" id="results"></div>

<div class="overlay hidden" id="overlay" tabindex="-1" role="dialog" aria-modal="true" aria-label="Video player">
  <video controls playsinline id="videoPlayer"></video>
  <div class="video-title" id="overlayTitle"></div>
  <div class="video-meta" id="overlayMeta"></div>
</div>

<script>
  const searchInput = document.getElementById('searchInput');
  const resultsDiv = document.getElementById('results');
  const overlay = document.getElementById('overlay');
  const videoPlayer = document.getElementById('videoPlayer');
  const overlayTitle = document.getElementById('overlayTitle');
  const overlayMeta = document.getElementById('overlayMeta');
  const apiButtons = document.querySelectorAll('.api-button');


  let selectedEndpoint = 'clipto';
  let currentQuery = '';
  let currentPage = 1;
  let isLoading = false;
  let hasMoreResults = true;

  apiButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      selectedEndpoint = btn.dataset.endpoint;
      apiButtons.forEach(b => b.style.backgroundColor = 'rgba(255 255 255 / 0.15)');
      btn.style.backgroundColor = 'rgba(255 255 255 / 0.35)';
    });
  });
  apiButtons[0].style.backgroundColor = 'rgba(255 255 255 / 0.35)';

  async function searchVideos(query, page = 1) {
    if (!query.trim()) return [];
    
    const maxResults = 15;
    const startIndex = (page - 1) * maxResults;
    const apiUrl = `/api/ytSearch?q=${encodeURIComponent(query)}&max=${maxResults}&start=${startIndex}`;
    
    try {
      const response = await fetch(apiUrl);
      if (!response.ok) throw new Error('Search failed');
      const data = await response.json();
      return data.results || [];
    } catch (error) {
      console.error('Search error:', error);
      return [];
    }
  }

  function clearResults() {
    resultsDiv.innerHTML = '';
    currentPage = 1;
    hasMoreResults = true;
  }

  function formatViews(num) {
    if (!num || num === 0) return '0';
    
    const units = [
      { value: 1e12, suffix: 'T' }, // like THATS gonna ever happen
      { value: 1e9, suffix: 'B' },
      { value: 1e6, suffix: 'M' },
      { value: 1e3, suffix: 'K' }
    ];
    
    for (const unit of units) {
      if (num >= unit.value) {
        const formatted = (num / unit.value).toFixed(1).replace(/\.0$/, '');
        return formatted + unit.suffix;
      }
    }
    
    return num.toString();
  }

  function createLoadingOverlay() {
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.style.display = 'none';
    
    const spinner = document.createElement('div');
    spinner.className = 'spinner';
    
    overlay.appendChild(spinner);
    return overlay;
  }

  function createVideoCard(video) {
    const card = document.createElement('div');
    card.className = 'video-card';
    card.tabIndex = 0;

    const thumbWrapper = document.createElement('div');
    thumbWrapper.className = 'video-thumb-wrapper';

    const thumb = document.createElement('img');
    thumb.className = 'video-thumb';
    thumb.src = video.thumbnail;
    thumb.alt = video.title;

    thumbWrapper.appendChild(thumb);

    const loadingOverlay = createLoadingOverlay();
    loadingOverlay.style.display = 'none';
    thumbWrapper.appendChild(loadingOverlay);

    const title = document.createElement('div');
    title.className = 'video-title';
    title.textContent = video.title;

    card.appendChild(thumbWrapper);
    card.appendChild(title);

    async function doTheVideoPlayingThingy() {
      loadingOverlay.style.display = 'flex';
      try {
        const clipApi = `/api/vyt/${selectedEndpoint}/${video.videoId}`;
        const res = await fetch(clipApi);
        if(!res.ok) throw new Error('API error');
        const data = await res.json();
        if(data.vlink){
          videoPlayer.src = data.vlink;
          overlayTitle.textContent = data.title || video.title;
          const viewsFormatted = formatViews(video.views);
          overlayMeta.textContent = `${video.author} • ${viewsFormatted} views`;
          document.body.style.overflow = 'hidden';
          overlay.classList.remove('hidden');
          videoPlayer.focus();
        } else {
          alert('failed to load stream!');
        }
      } catch {
        alert('failed to load stream!');
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    card.addEventListener('click', doTheVideoPlayingThingy);
    card.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        doTheVideoPlayingThingy();
      }
    });

    return card;
  }

  function closeOverlay() {
    overlay.classList.add('hidden');
    videoPlayer.pause();
    videoPlayer.src = '';
    overlayTitle.textContent = '';
    overlayMeta.textContent = '';
    document.body.style.overflow = '';
  }

  async function loadMoreVideos() {
    if (isLoading || !hasMoreResults || !currentQuery) return;
    
    isLoading = true;
    currentPage++;
    
    const videos = await searchVideos(currentQuery, currentPage);
    
    if (videos.length === 0 || videos.length < 15) {
      hasMoreResults = false;
    }
    
    if (videos.length > 0) {
      videos.forEach(video => {
        resultsDiv.appendChild(createVideoCard(video));
      });
    }
    
    isLoading = false;
  }

  function handleScroll() {
    const scrollPosition = window.innerHeight + window.scrollY;
    const documentHeight = document.documentElement.offsetHeight;
    
    if (scrollPosition >= documentHeight - 100) { 
      loadMoreVideos();
    }
  }

  window.addEventListener('scroll', handleScroll);

  let searchTimeout = null;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      const query = searchInput.value.trim();
      currentQuery = query;
      if (!query) {
        clearResults();
        return;
      }
      
      isLoading = true;
      const videos = await searchVideos(query, 1);
      clearResults();
      
      if (videos.length === 0) {
        resultsDiv.textContent = 'No results found.';
        hasMoreResults = false;
      } else {
        videos.forEach(video => {
          resultsDiv.appendChild(createVideoCard(video));
        });
        hasMoreResults = videos.length === 15;
      }
      
      isLoading = false;
    }, 350);
  });

  searchInput.addEventListener('keydown', e => {
    if(e.key === 'Enter'){
      e.preventDefault();
      const query = searchInput.value.trim();
      currentQuery = query;
      if(query){
        clearTimeout(searchTimeout);
        
        isLoading = true;
        searchVideos(query, 1).then(videos => {
          clearResults();
          if(videos.length === 0){
            resultsDiv.textContent = 'No results!';
            hasMoreResults = false;
          } else {
            videos.forEach(video => resultsDiv.appendChild(createVideoCard(video)));
            hasMoreResults = videos.length === 15;
          }
          isLoading = false;
        });
      }
    }
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeOverlay();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !overlay.classList.contains('hidden')) {
      closeOverlay();
    }
  });


</script>

</body>
</html>