<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/styles/defaults.css" />
  <script src="/scripts/opt.js"></script>
  <script src="/scripts/theme.js"></script>
  <style>
    .title,
    button {
      color: var(--secondary-text-color);
    }

    * {
      box-sizing: border-box;
      font-family: Inter;
    }

    body,
    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg);
      color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }

    .content-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      width: 100%;
      padding: 16px;
      gap: 25px;
    }

    .left-container,
    .right-container {
      position: relative;
      display: flex;
      flex-direction: column;
      background: var(--fourth-bg);
      width: 35%;
      border-radius: 12px;
      padding: 24px;
      text-align: left;
      justify-content: space-between;
      height: 80%;
    }
    
    .right-container {
        display: flex;
        align-items: space-between;
    }

    .button-container,
    .footer,
    .session-status,
    .status {
      text-align: center;
    }

    .title {
      font-size: 30px;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .body-text {
      font-size: 16px;
      color: var(--secondary-text-color);
      margin-bottom: 20px;
    }

    .session-status {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--secondary-text-color);
    }

    .button-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      background-color: #4c75f2;
      border: none;
      border-radius: 10px;
      transition: 0.3s;
      width: 100%;
    }

    button:hover {
      background-color: #3a5bc0;
    }

    button:disabled {
      background-color: rgba(255, 255, 255, 0.2);
      cursor: not-allowed;
      color: rgba(255, 255, 255, 0.5);
    }

    #createSession {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      padding: 5px;
      background: linear-gradient(45deg, #6366f1, #8fd7eb, #6366f1);
      background-size: 400% 400%;
      animation: gradientBg 3s linear infinite;
      position: relative;
      overflow: hidden;
      background-clip: padding-box;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.5), 0 0 20px rgba(143, 215, 235, 0.3);
    }

    #createSession div {
      background: #263143;
      width: 100%;
      height: 100%;
      padding: 20px 36px;
      border-radius: 5px;
      transition: 0.3s;
    }

    #createSession span {
      background: linear-gradient(45deg, #6366f1, #8fd7eb, #6366f1);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientText 3s linear infinite;
    }

    #createSession:hover {
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.5), 0 0 60px rgba(143, 215, 235, 0.3);
      transform: scale(1.02);
    }

    #createSession:active {
      transform: scale(0.98);
    }

    #createSession:hover div {
      background: #26314300;
    }

    #createSession:hover span {
      -webkit-text-fill-color: white;
      color: white;
    }

    #joinSession {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      padding: 5px;
      background: linear-gradient(45deg, #34d399, #10b981, #34d399);
      background-size: 400% 400%;
      animation: gradientBg 3s linear infinite;
      position: relative;
      overflow: hidden;
      background-clip: padding-box;
      box-shadow: 0 0 10px rgba(52, 211, 153, 0.5), 0 0 20px rgba(16, 185, 129, 0.3);
    }

    #joinSession div {
      background: #263143;
      width: 100%;
      height: 100%;
      padding: 20px 36px;
      border-radius: 5px;
      transition: 0.3s;
    }

    #joinSession span {
      background: linear-gradient(45deg, #34d399, #10b981, #34d399);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientText 3s linear infinite;
    }

    #joinSession:hover {
      box-shadow: 0 0 30px rgba(52, 211, 153, 0.5), 0 0 60px rgba(16, 185, 129, 0.3);
      transform: scale(1.02);
    }

    #joinSession:active {
      transform: scale(0.98);
    }

    #joinSession:hover div {
      background: #26314300;
    }

    #joinSession:hover span {
      -webkit-text-fill-color: white;
      color: white;
    }

    @keyframes gradientText {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 400% 50%;
      }
    }

    @keyframes gradientBg {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 400% 50%;
      }
    }

    .vm-session-container {
      display: none;
      flex-direction: column;
      width: 100%;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background-color: var(--bg);
      z-index: 1;
    }

    .vm-controls-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background-color: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      min-height: 60px;
    }

    .vm-left-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .vm-right-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .hyperbeam-container {
      flex: 1;
      width: 100%;
      background-color: #1a1a1a;
      overflow: hidden;
    }

    .end-session-btn,
    .close-tabs-btn,
    .share-btn,
    .leave-session-btn,
    .timer {
      color: rgba(255, 255, 255, 0.9);
      background-color: rgba(255, 255, 255, 0.08);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      border: none;
      font-family: inherit;
      cursor: pointer;
      transition: 0.2s;
      white-space: nowrap;
    }

    .end-session-btn:hover,
    .leave-session-btn:hover {
      background-color: rgba(255, 107, 107, 0.2);
    }

    .close-tabs-btn:hover {
      background-color: rgba(255, 255, 255, 0.15);
    }

    .share-btn {
      background-color: rgba(52, 211, 153, 0.1);
    }

    .share-btn:hover {
      background-color: rgba(52, 211, 153, 0.2);
    }

    .timer,
    .remote-session-indicator {
      cursor: default;
      font-weight: 500;
    }

    .countdown {
      font-weight: 700;
      color: #4c75f2;
    }

    .remote-session-indicator {
      color: #34d399;
    }

    .status {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 12px 16px;
      color: rgba(255, 255, 255, 0.9);
      background-color: rgba(255, 255, 255, 0.08);
      max-width: 320px;
      z-index: 100;
      border-radius: 10px;
      backdrop-filter: blur(4px);
      display: none;
    }

    .footer {
      margin-top: 16px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      bottom: 8px;
    }

    .footer-image {
      margin-top: auto;
      text-align: center;
      padding-top: 20px;
    }

    .footer-image img {
      width: 100%;
      border-radius: 4px;
      filter: brightness(0.9);
    }

    .loading-icon {
      animation: 1s linear infinite spin;
      margin-right: 4px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .connection-status {
      display: none !important;
    }

    .hyperbeam-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #0a111d;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      gap: 12px;
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
    }

    .hyperbeam-overlay .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top: 2px solid #4c75f2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .share-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    .share-modal {
      background: var(--fourth-bg);
      border-radius: 24px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: scaleIn 0.3s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .share-modal h3 {
      color: var(--secondary-text-color);
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 16px 0;
      text-align: left;
    }

    .share-modal p {
      color: var(--secondary-text-color);
      font-size: 16px;
      margin: 0 0 24px 0;
      opacity: 0.8;
      text-align: left;
    }

    .share-code-container {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
      position: relative;
      text-align: left;
    }

    .share-code {
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: 600;
      color: #34d399;
      word-break: break-all;
      line-height: 1.4;
    }

    .copy-status {
      position: absolute;
      top: -8px;
      right: 12px;
      background: #34d399;
      color: #000;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      display: none;
    }

    .copy-status.show {
      opacity: 1;
      transform: translateY(0);
    }

    .share-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .share-modal button {
      padding: 16px 28px;
      border: none;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .copy-btn {
      background: linear-gradient(45deg, #34d399, #10b981);
      color: white;
      width: auto;
    }

    .copy-btn:hover {
      background: linear-gradient(45deg, #10b981, #059669);
    }

    .close-modal-btn {
      background: rgba(255, 255, 255, 0.1);
      color: var(--secondary-text-color);
      width: auto;
    }

    .close-modal-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>

<body>
  <div class="content-container" id="introContainer">
    <div class="left-container">
      <div class="title">VAPOR Private VMs</div>
      <div class="body-text">
        VAPOR Private VMs are isolated, personal browsers available in the
        cloud.<br /><br />Need to search something? Need to test a sketchy
        site? Try Private VMs.<br /><br />12 minutes of uninterrupted
        browsing. Ran out of time? In a single click, create a new session
        right away.
      </div>
      <div class="footer-image">
        <img src="/_a/img/priv-vm-snapshot.png" alt="Screenshot of the browser." />
      </div>
    </div>

    <div class="right-container">
      <div class="button-container">
        <button id="createSession">
          <div>
            <span><i class="fa-regular fa-desktop" style="margin-right: 5px"></i>
              Start Session</span>
          </div>
        </button>
        <button id="joinSession">
          <div>
            <span><i class="fa-solid fa-users" style="margin-right: 5px"></i>
              Join Session</span>
          </div>
        </button>
      </div>
      <iframe 
  src="/ads/300x250.html" 
  width="300" 
  height="250"
  sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox"
  scrolling="no"
  style="border:0;" 
  referrerpolicy="no-referrer">
</iframe>
    </div>
  </div>

  <!-- the sesh container  -->
  <div id="vmSessionContainer" class="vm-session-container">
    <div class="vm-controls-bar">
      <div class="vm-left-controls">
        <button id="endSessionBtn" class="end-session-btn">
          <i class="fa-regular fa-stop-circle"></i> End Session
        </button>
        <button id="leaveSessionBtn" class="leave-session-btn" style="display: none;">
          <i class="fa-solid fa-arrow-right-from-bracket"></i> Leave Session
        </button>
        <button id="closeTabsBtn" class="close-tabs-btn">
          <i class="fas fa-times"></i> Close All Tabs
        </button>
        <button id="shareBtn" class="share-btn" style="display: none;">
          <i class="fa-solid fa-share"></i> Share
        </button>
      </div>
      <div class="vm-right-controls">
        <div id="timer" class="timer">
          <i class="fas fa-clock"></i> Time left:
          <span id="countdown" class="countdown">30</span>s
        </div>
        <div id="remoteSessionIndicator" class="remote-session-indicator" style="display: none;">
          <i class="fa-solid fa-satellite-dish"></i> Remote Session
        </div>
      </div>
    </div>
    <div id="hyperbeamContainer" class="hyperbeam-container"></div>
  </div>

  <div id="status" class="status"></div>
  <div id="loadingOverlay" class="hyperbeam-overlay" style="display: none;"></div>
  <div id="connectionStatus" class="connection-status"></div>

<!-- share modal -->
  <div id="shareModalOverlay" class="share-modal-overlay">
    <div class="share-modal">
      <h3><i class="fa-solid fa-share" style="margin-right: 8px"></i>Share Session</h3>
      <p>Give this code to your friend so they can collab on this VM:</p>
      
      <div class="share-code-container">
        <div id="shareCode" class="share-code">--</div>
        <div id="copyStatus" class="copy-status">Copied!</div>
      </div>
      
      <div class="share-modal-buttons">
        <button id="copyCodeBtn" class="copy-btn">
          <i class="fa-solid fa-copy" style="margin-right: 6px"></i>Copy
        </button>
        <button id="closeModalBtn" class="close-modal-btn">
          <i class="fa-solid fa-times" style="margin-right: 6px"></i>Close
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import Hyperbeam from "/v0/vm/index.js";

    const createSessionBtn = document.getElementById("createSession");
    const joinSessionBtn = document.getElementById("joinSession");
    const vmSessionContainer = document.getElementById("vmSessionContainer");
    const hyperbeamContainer = document.getElementById("hyperbeamContainer");
    const timer = document.getElementById("timer");
    const countdown = document.getElementById("countdown");
    const status = document.getElementById("status");
    const endSessionBtn = document.getElementById("endSessionBtn");
    const leaveSessionBtn = document.getElementById("leaveSessionBtn");
    const closeTabsBtn = document.getElementById("closeTabsBtn");
    const shareBtn = document.getElementById("shareBtn");
    const remoteSessionIndicator = document.getElementById("remoteSessionIndicator");
    const connectionStatus = document.getElementById("connectionStatus");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const shareModalOverlay = document.getElementById("shareModalOverlay");
    const shareCodeElement = document.getElementById("shareCode");
    const copyCodeBtn = document.getElementById("copyCodeBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const copyStatus = document.getElementById("copyStatus");
    const API_URL = window.location.origin;

    let countdownInterval;
    let currentSessionId = null;
    let isTerminating = false;
    let hyperbeamInstance = null;
    let adminToken = null;
    let csrfToken = null;
    let isJoinedSession = false;
    let currentEmbedUrl = null;

    async function getCSRFToken() {
      try {
        const response = await fetch(`${API_URL}/v0/vm/csrf-token`);
        const data = await response.json();
        csrfToken = data.csrfToken;
        return csrfToken;
      } catch (error) {
        console.error('csrf token fetch fail ', error);
        throw error;
      }
    }

    getCSRFToken();

    function updateCountdownDisplay(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      countdown.textContent = `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
    }

    function updateConnectionStatus(state) {
      console.log('connection status:', state);
    }

    function generateShareCode(embedUrl) {
      // yes i asked chatgpt for the regex dont judge me
      const urlParts = embedUrl.match(/https:\/\/([^.]+)\.hyperbeam\.com\/([^?]+)\?token=(.+)/);
      if (urlParts && urlParts.length === 4) {
        const part1 = urlParts[1];
        const part2 = urlParts[2];
        const part3 = urlParts[3];
        return `${part1}|${part2}|${part3}`;
      }
      return null;
    }

    function reconstructEmbedUrl(shareCode) {
      const parts = shareCode.split('|');
      if (parts.length === 3) {
        return `https://${parts[0]}.hyperbeam.com/${parts[1]}?token=${parts[2]}`;
      }
      return null;
    }

    async function endSession(showUI = true) {
      if (isTerminating || !currentSessionId) return;

      isTerminating = true;

      if (showUI) {
        status.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Ending session...';
        status.style.display = "block";
      }

      if (hyperbeamInstance) {
        try {
          await hyperbeamInstance.destroy();
          hyperbeamInstance = null;
        } catch (error) {
          console.error("Error destroying Hyperbeam instance:", error);
        }
      }

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);

        await getCSRFToken();

        const response = await fetch(`${API_URL}/v0/vm/terminate`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-csrf-token": csrfToken
          },
          body: JSON.stringify({
            sessionId: currentSessionId,
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (showUI) {
          if (response.ok) {
            status.innerHTML = '<i class="fas fa-check-circle"></i> Session ended';
          } else {
            status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Session ended (cleanup may be delayed)';
          }

          setTimeout(() => {
            status.style.display = "none";
          }, 2000);
        }

      } catch (error) {
        console.error("Error terminating session:", error);
        if (showUI) {
          status.innerHTML = '<i class="fas fa-times-circle"></i> Session ended (cleanup may be delayed)';
          setTimeout(() => {
            status.style.display = "none";
          }, 2000);
        }
      }

      resetSessionUI();
      isTerminating = false;

      getCSRFToken();
    }

    async function leaveSession() {
      if (hyperbeamInstance) {
        try {
          await hyperbeamInstance.destroy();
          hyperbeamInstance = null;
        } catch (error) {
          console.error("Error destroying Hyperbeam instance:", error);
        }
      }
      resetSessionUI();
    }

    function resetSessionUI() {
      currentSessionId = null;
      currentEmbedUrl = null;
      isJoinedSession = false;
      hyperbeamContainer.innerHTML = '';
      vmSessionContainer.style.display = "none";
      createSessionBtn.style.display = "block";
      createSessionBtn.disabled = false;
      createSessionBtn.innerHTML = '<div><span><i class="fa-regular fa-desktop" style="margin-right: 5px"></i>Start Session</span></div>';
      joinSessionBtn.disabled = false;
      joinSessionBtn.innerHTML = '<div><span><i class="fa-solid fa-users" style="margin-right: 5px"></i>Join Session</span></div>';
      countdown.style.color = "#4C75F2";
      document.getElementById("introContainer").style.display = "flex";

      // Reset button visibility
      endSessionBtn.style.display = "block";
      leaveSessionBtn.style.display = "none";
      closeTabsBtn.style.display = "block";
      shareBtn.style.display = "none";
      timer.style.display = "block";
      remoteSessionIndicator.style.display = "none";

      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    let isUnloading = false;

    window.addEventListener("beforeunload", (e) => {
      if (currentSessionId && !isTerminating && csrfToken && !isJoinedSession) {
        isUnloading = true;
        const data = JSON.stringify({
          sessionId: currentSessionId,
          csrfToken: csrfToken
        });

        const blob = new Blob([data], { type: 'application/json' });
        navigator.sendBeacon(`${API_URL}/v0/vm/terminate`, blob);
      }
    });

    window.addEventListener("unload", (e) => {
      if (currentSessionId && !isUnloading && csrfToken && !isJoinedSession) {
        const data = JSON.stringify({
          sessionId: currentSessionId,
          csrfToken: csrfToken
        });

        const blob = new Blob([data], { type: 'application/json' });
        navigator.sendBeacon(`${API_URL}/v0/vm/terminate`, blob);
      }
    });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden && currentSessionId && !isTerminating) {
        // endSession(false);
      }
    });

    endSessionBtn.addEventListener("click", () => {
      endSession(true);
    });

    leaveSessionBtn.addEventListener("click", () => {
      leaveSession();
    });

    shareBtn.addEventListener("click", async () => {
      if (currentEmbedUrl) {
        const shareCode = generateShareCode(currentEmbedUrl);
        if (shareCode) {
          shareCodeElement.textContent = shareCode;
          shareModalOverlay.style.display = "flex";
        } else {
          alert("Share code couldn't be generated.");
        }
      }
    });

    copyCodeBtn.addEventListener("click", async () => {
      const shareCode = shareCodeElement.textContent;
      try {
        await navigator.clipboard.writeText(shareCode);
        showCopyStatus();
      } catch (error) {
        console.error("Failed to copy ", error);
        const range = document.createRange();
        range.selectNode(shareCodeElement);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
      }
    });

    closeModalBtn.addEventListener("click", () => {
      shareModalOverlay.style.display = "none";
    });

    shareModalOverlay.addEventListener("click", (e) => {
      if (e.target === shareModalOverlay) {
        shareModalOverlay.style.display = "none";
      }
    });

    function showCopyStatus() {
      copyStatus.classList.add("show");
      setTimeout(() => {
        copyStatus.classList.remove("show");
      }, 2000);
    }

    closeTabsBtn.addEventListener("click", async () => {
      if (hyperbeamInstance && adminToken) {
        try {
          const tabs = await hyperbeamInstance.tabs.query({});
          console.log("Found tabs:", tabs);

          const tabIds = tabs.map(tab => tab.id);
          await hyperbeamInstance.tabs.remove(tabIds);
          console.log("Closed all tabs:", tabIds);

        } catch (error) {
          console.error("Error closing tabs:", error);
        }
      } else {
        console.log("No hyperbeam instance or admin token available");
      }
    });

    joinSessionBtn.addEventListener("click", async () => {
      const shareCode = prompt("Enter the share code from your friend:");
      if (!shareCode) return;

      const embedUrl = reconstructEmbedUrl(shareCode.trim());
      if (!embedUrl) {
        alert("Code invalid!");
        return;
      }

      joinSessionBtn.disabled = true;
      joinSessionBtn.innerHTML = '<i class="fas fa-circle-notch loading-icon"></i> Joining...';
      status.style.display = "none";
      document.getElementById("introContainer").style.display = "none";

      try {
        currentEmbedUrl = embedUrl;
        currentSessionId = embedUrl.split('/').pop().split('?')[0];
        isJoinedSession = true;

        hyperbeamContainer.innerHTML = '';
        vmSessionContainer.style.display = "flex";

        endSessionBtn.style.display = "none";
        leaveSessionBtn.style.display = "block";
        closeTabsBtn.style.display = "none";
        shareBtn.style.display = "none";
        timer.style.display = "none";
        remoteSessionIndicator.style.display = "block";

        loadingOverlay.innerHTML = '<div class="loading-spinner"></div>Joining session...';
        loadingOverlay.style.display = "flex";

        createSessionBtn.style.display = "none";

        setTimeout(() => {
          loadingOverlay.style.display = "none";
        }, 800);

        try {
          hyperbeamInstance = await Hyperbeam(hyperbeamContainer, embedUrl, {
            volume: 0.8,
            videoPaused: false,
            delegateKeyboard: true,

            onConnectionStateChange: ({ state }) => {
              console.log('Connection state:', state);
              updateConnectionStatus(state);
            },

            onDisconnect: ({ type }) => {
              console.log('Disconnected:', type);
              if (type !== 'request') {
                if (isJoinedSession) {
                  status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Session was ended by host';
                } else {
                  status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Connection lost';
                }
                status.style.display = "block";
                setTimeout(() => {
                  if (isJoinedSession) {
                    leaveSession();
                  } else {
                    endSession(false);
                  }
                }, 2000);
              }
            },

            onCloseWarning: ({ type, deadline }) => {
              if (deadline) {
                console.log(`${type} timeout warning: ${deadline.delay}ms remaining`);
              }
            }
          });

          console.log('Joined session successfully :)');

        } catch (hyperbeamError) {
          console.error("Failed to join session >:(", hyperbeamError);
          status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to join session';
          status.style.display = "block";
          joinSessionBtn.disabled = false;
          joinSessionBtn.innerHTML = '<div><span><i class="fa-solid fa-users" style="margin-right: 5px"></i>Join Session</span></div>';
          document.getElementById("introContainer").style.display = "flex";
          vmSessionContainer.style.display = "none";

          setTimeout(() => {
            status.style.display = "none";
          }, 5000);
          return;
        }

      } catch (error) {
        console.error("Error joining session:", error);
        status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to join session';
        status.style.display = "block";
        joinSessionBtn.disabled = false;
        joinSessionBtn.innerHTML = '<div><span><i class="fa-solid fa-users" style="margin-right: 5px"></i>Join Session</span></div>';
        document.getElementById("introContainer").style.display = "flex";

        setTimeout(() => {
          status.style.display = "none";
        }, 5000);
      }
    });

    createSessionBtn.addEventListener("click", async () => {
      createSessionBtn.disabled = true;
      createSessionBtn.innerHTML = '<i class="fas fa-circle-notch loading-icon"></i> Creating...';
      status.style.display = "none";
      document.getElementById("introContainer").style.display = "none";

      try {
        await getCSRFToken();

        const response = await fetch(`${API_URL}/v0/vm/create`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-csrf-token": csrfToken
          },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (data.error) {
          status.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.error;
          status.style.display = "block";
          createSessionBtn.disabled = false;
          createSessionBtn.innerHTML = '<i class="fas fa-redo"></i> Try Again';
          document.getElementById("introContainer").style.display = "flex";

          await getCSRFToken();

          setTimeout(() => {
            status.style.display = "none";
          }, 5000);
          return;
        }

        const embedUrl = data.embed_url;
        currentSessionId = data.session_id || embedUrl.split('/').pop();
        currentEmbedUrl = embedUrl;
        adminToken = data.admin_token;
        isJoinedSession = false;

        hyperbeamContainer.innerHTML = '';
        vmSessionContainer.style.display = "flex";

        // Update UI for own session
        endSessionBtn.style.display = "block";
        leaveSessionBtn.style.display = "none";
        closeTabsBtn.style.display = "none";
        shareBtn.style.display = "block";
        timer.style.display = "block";
        remoteSessionIndicator.style.display = "none";

        loadingOverlay.innerHTML = '<div class="loading-spinner"></div>One sec...';
        loadingOverlay.style.display = "flex";

        createSessionBtn.style.display = "none";

        let timeLeft = 720;
        updateCountdownDisplay(timeLeft);

        setTimeout(() => {
          loadingOverlay.style.display = "none";
        }, 800);

        try {
          hyperbeamInstance = await Hyperbeam(hyperbeamContainer, embedUrl, {
            timeout: 720,
            volume: 0.8,
            videoPaused: false,
            delegateKeyboard: true,
            adminToken: adminToken,

            onConnectionStateChange: ({ state }) => {
              console.log('Connection state:', state);
              updateConnectionStatus(state);
            },

            onDisconnect: ({ type }) => {
              console.log('Disconnected:', type);
              if (type !== 'request') {
                status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Connection lost';
                status.style.display = "block";
                setTimeout(() => {
                  endSession(false);
                }, 2000);
              }
            },

            onCloseWarning: ({ type, deadline }) => {
              if (deadline) {
                console.log(`${type} timeout warning: ${deadline.delay}ms remaining`);
              }
            }
          });

          console.log('hb init successful :)');

        } catch (hyperbeamError) {
          console.error("hb init failed >:(", hyperbeamError);
          status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to connect to browser';
          status.style.display = "block";
          createSessionBtn.disabled = false;
          createSessionBtn.innerHTML = '<div><span><i class="fa-regular fa-desktop" style="margin-right: 5px"></i>Start Session</span></div>';
          document.getElementById("introContainer").style.display = "flex";
          vmSessionContainer.style.display = "none";

          await getCSRFToken();

          setTimeout(() => {
            status.style.display = "none";
          }, 5000);
          return;
        }

        countdownInterval = setInterval(() => {
          timeLeft--;
          updateCountdownDisplay(timeLeft);

          if (timeLeft <= 60) {
            countdown.style.color = "#ff6b6b";
          }

          if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            endSession(true);
          }
        }, 1000);

      } catch (error) {
        console.error("Error creating session:", error);
        status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> No sessions available';
        status.style.display = "block";
        createSessionBtn.disabled = false;
        createSessionBtn.innerHTML = '<div><span><i class="fa-regular fa-desktop" style="margin-right: 5px"></i>Start Session</span></div>';
        document.getElementById("introContainer").style.display = "flex";

        await getCSRFToken();

        setTimeout(() => {
          status.style.display = "none";
        }, 5000);
      }
    });
  </script>
</body>

</html>