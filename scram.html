
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scramjet</title>
    <link rel="icon" href="favicon.webp" />
    <link rel="prefetch" href="/scram/scramjet.worker.js" />
    <link rel="prefetch" href="/scram/scramjet.shared.js" />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&amp;family=Inter+Tight:ital,wght@0,100..900;1,100..900&amp;family=Inter:wght@100..900&amp;display=swap&amp;"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Hind:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Hind:wght@300;400;500;600;700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />
    <style>
      body,
      html,
      #app {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        background-color: #050505;
        overflow: hidden;
      }

      @keyframes fade {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/dreamland"></script>
    <script src="/baremux/index.js"></script>
    <script src="/scram/scramjet.controller.js"></script>
    <script src="config.js"></script>

  <body>
    <div id="app"></div>
    <script>
      const scramjet = new ScramjetController({
  files: {
    wasm: "/scram/scramjet.wasm.wasm",
    worker: "/scram/scramjet.worker.js",
    client: "/scram/scramjet.client.js",
    shared: "/scram/scramjet.shared.js",
    sync: "/scram/scramjet.sync.js",
  },
});

scramjet.init();
navigator.serviceWorker.register("./sw.js");

const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
const flex = css`
  display: flex;
`;
const col = css`
  flex-direction: column;
`;

const store = $store(
  {
    url: "https://",
    wispurl:
      _CONFIG?.wispurl ||
      (location.protocol === "https:" ? "wss" : "ws") +
        "://" +
        location.host +
        "/wisp/",
    bareurl:
      _CONFIG?.bareurl ||
      (location.protocol === "https:" ? "https" : "http") +
        "://" +
        location.host +
        "/bare/",
    proxy: "",
  },
  { ident: "settings", backing: "localstorage", autosave: "auto" }
);
connection.setTransport("/epoxy/index.mjs", [{ wisp: store.wispurl }]);

function Config() {
  this.css = `
    transition: opacity 0.4s ease;
    :modal[open] {
        animation: fade 0.4s ease normal;
    }

    :modal::backdrop {
     backdrop-filter: blur(3px);
    }

    .buttons {
      gap: 0.5em;
    }
    .buttons button {
      border: 1px solid #4c8bf5;
      background-color: #313131;
      border-radius: 0.75em;
      color: #fff;
      padding: 0.45em;
    }
    .input_row input {
      background-color: rgb(18, 18, 18);
      border: 2px solid rgb(49, 49, 49);
      border-radius: 0.75em;
      color: #fff;
      outline: none;
      padding: 0.45em;
    }
    .input_row {
      margin-bottom: 0.5em;
      margin-top: 0.5em;
    }
    .input_row input {
      flex-grow: 1;
    }
    .centered {
      justify-content: center;
      align-items: center;
    }
  `;

  function handleModalClose(modal) {
    modal.style.opacity = 0;
    setTimeout(() => {
      modal.close();
      modal.style.opacity = 1;
    }, 250);
  }

  return html`
      <dialog class="cfg" style="background-color: #121212; color: white; border-radius: 8px;">
        <div style="align-self: end">
          <div class=${[flex, "buttons"]}>
            <button on:click=${() =>
              connection.setTransport("/baremod/index.mjs", [
                store.bareurl,
              ])}>use bare server 3</button>
            <button on:click=${() =>
              connection.setTransport("/libcurl/index.mjs", [
                { wisp: store.wispurl },
              ])}>use libcurl.js</button>
              <button on:click=${() =>
                connection.setTransport("/epoxy/index.mjs", [
                  { wisp: store.wispurl },
                ])}>use epoxy</button>
          </div>
        </div>
        <div class=${[flex, col, "input_row"]}>
          <label for="wisp_url_input">Wisp URL:</label>
          <input id="wisp_url_input" bind:value=${use(
            store.wispurl
          )} spellcheck="false"></input>
        </div>
        <div class=${[flex, col, "input_row"]}>
          <label for="bare_url_input">Bare URL:</label>
          <input id="bare_url_input" bind:value=${use(
            store.bareurl
          )} spellcheck="false"></input>
        </div>
            <div class=${[flex, "buttons", "centered"]}>
              <button on:click=${() =>
                handleModalClose(this.root)}>close</button>
            </div>

      </dialog>
  `;
}

function BrowserApp() {
  this.css = `
    width: 100%;
    height: 100%;
    color: #e0def4;
    display: flex;
    flex-direction: column;
    padding: 0.5em;
    padding-top: 0;
    box-sizing: border-box;

    a {
      color: #e0def4;
    }

    input,
    button {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        sans-serif;
    }
    .version {
    }
    h1 {
      font-family: "Inter Tight", "Inter", system-ui, -apple-system, BlinkMacSystemFont,
      sans-serif;
      margin-bottom: 0;
    }
    iframe {
      background-color: #fff;
      border: none;
      border-radius: 0.3em;
      flex: 1;
      width: 100%;
    }

    input.bar {
      font-family: "Inter";
      padding: 0.1em;
      padding-left: 0.3em;
      border: none;
      outline: none;
      color: #fff;
      height: 1.5em;
      border-radius: 0.3em;
      flex: 1;

      background-color: #121212;
      border: 1px solid #313131;
    }
    .input_row > label {
      font-size: 0.7rem;
      color: gray;
    }
    p {
      margin: 0;
      margin-top: 0.2em;
    }

    .nav {
      padding-top: 0.3em;
      padding-bottom: 0.3em;
      gap: 0.3em;
    }
    spacer {
      margin-left: 10em;
    }

    .nav button {
      color: #fff;
      outline: none;
      border: none;
      border-radius: 0.30em;
      background-color: #121212;
      border: 1px solid #313131;
    }

    .tabs {
      padding-top: 0.3em;
      padding-bottom: 0.3em;
      gap: 0.2em;
      border-bottom: 1px solid #313131;
    }

    .tab {
      color: #fff;
      outline: none;
      border: none;
      border-radius: 0.30em;
      background-color: #121212;
      border: 1px solid #313131;
      padding: 0.3em 0.6em;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 0.3em;
      cursor: pointer;
    }

    .tab.active {
      background-color: #1e1e1e;
      border-color: #4c8bf5;
    }

    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tab-close {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
    }

    .tab-close:hover {
      background-color: #333;
      color: #fff;
    }

    .new-tab {
      color: #fff;
      outline: none;
      border: none;
      border-radius: 0.30em;
      background-color: #121212;
      border: 1px solid #313131;
      padding: 0.3em;
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .new-tab:hover {
      background-color: #1e1e1e;
    }

    .iframe-container {
      flex: 1;
      position: relative;
    }

    .iframe-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .iframe-container iframe:not(.active) {
      display: none;
    }
  `;

  // Initialize tabs state
  this.tabs = $store([
    {
      id: 1,
      title: "New Tab",
      url: "https://",
      frame: null
    }
  ], { autosave: false });
  
  this.activeTabId = $store(1, { autosave: false });
  this.nextTabId = 2;

  // Create initial frame
  const initialFrame = scramjet.createFrame();
  this.tabs[0].frame = initialFrame;

  // Set up frame event listener for title updates
  const setupFrameListeners = (tab) => {
    tab.frame.addEventListener("urlchange", (e) => {
      if (!e.url) return;
      tab.url = e.url;
      
      // Try to get title from iframe
      try {
        const title = tab.frame.frame.contentWindow?.document?.title || new URL(e.url).hostname;
        tab.title = title || "Loading...";
      } catch (err) {
        tab.title = new URL(e.url).hostname || "Loading...";
      }
    });
  };

  setupFrameListeners(this.tabs[0]);

  const getActiveTab = () => {
    return this.tabs.find(tab => tab.id === this.activeTabId);
  };

  const createNewTab = () => {
    const newTab = {
      id: this.nextTabId++,
      title: "New Tab",
      url: "https://",
      frame: scramjet.createFrame()
    };
    
    setupFrameListeners(newTab);
    this.tabs.push(newTab);
    this.activeTabId = newTab.id;
  };

  const closeTab = (tabId) => {
    const tabIndex = this.tabs.findIndex(tab => tab.id === tabId);
    if (tabIndex === -1 || this.tabs.length === 1) return;
    
    this.tabs.splice(tabIndex, 1);
    
    if (this.activeTabId === tabId) {
      const newActiveIndex = Math.min(tabIndex, this.tabs.length - 1);
      this.activeTabId = this.tabs[newActiveIndex].id;
    }
  };

  const switchTab = (tabId) => {
    this.activeTabId = tabId;
  };

  const handleSubmit = () => {
    const activeTab = getActiveTab();
    if (!activeTab) return;
    
    activeTab.url = activeTab.url.trim();
    if (!activeTab.url.startsWith("http")) {
      activeTab.url = "https://" + activeTab.url;
    }

    return activeTab.frame.go(activeTab.url);
  };

  const cfg = h(Config);
  document.body.appendChild(cfg);
  this.githubURL = `https://github.com/MercuryWorkshop/scramjet/commit/${$scramjet.version.build}`;

  return html`
      <div>
      <!-- Tabs Row -->
      <div class=${[flex, "tabs"]}>
        ${this.tabs.map(tab => html`
          <div class=${["tab", tab.id === this.activeTabId ? "active" : ""]} 
               on:click=${() => switchTab(tab.id)}>
            <span class="tab-title">${tab.title}</span>
            <button class="tab-close" on:click=${(e) => {
              e.stopPropagation();
              closeTab(tab.id);
            }}>×</button>
          </div>
        `)}
        <button class="new-tab" on:click=${createNewTab}>+</button>
      </div>

      <!-- Navigation Row -->
      <div class=${[flex, "nav"]}>
        <button on:click=${() => cfg.showModal()}>Configuration</button>
        <button on:click=${() => getActiveTab()?.frame.back()}>&lt;-</button>
        <button on:click=${() => getActiveTab()?.frame.forward()}>-&gt;</button>
        <button on:click=${() => getActiveTab()?.frame.reload()}>&#x21bb;</button>

        <input class="bar" autocomplete="off" autocapitalize="off" autocorrect="off" 
        bind:value=${use(() => getActiveTab()?.url || "")} 
        on:input=${(e) => {
          const activeTab = getActiveTab();
          if (activeTab) {
            activeTab.url = e.target.value;
          }
        }} 
        on:keyup=${(e) => e.keyCode == 13 && handleSubmit()}></input>

        <button on:click=${() => {
          const activeTab = getActiveTab();
          if (activeTab) {
            window.open(scramjet.encodeUrl(activeTab.url));
          }
        }}>Open</button>

        <p class="version">
          <b>VAPOR Scramjet build</b>
        </p>
      </div>

      <!-- Iframe Container -->
      <div class="iframe-container">
        ${this.tabs.map(tab => {
          tab.frame.frame.className = tab.id === this.activeTabId ? "active" : "";
          return tab.frame.frame;
        })}
      </div>
    </div>
    `;
}

window.addEventListener("load", async () => {
  const root = document.getElementById("app");
  try {
    root.replaceWith(h(BrowserApp));
  } catch (e) {
    root.replaceWith(document.createTextNode("" + e));
    throw e;
  }
  function b64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }

    return btoa(binary);
  }
  const arraybuffer = await (await fetch("/assets/scramjet.png")).arrayBuffer();
  console.log(
    "%cb",
    `
      background-image: url(data:image/png;base64,${b64(arraybuffer)});
      color: transparent;
      padding-left: 200px;
      padding-bottom: 100px;
      background-size: contain;
      background-position: center center;
      background-repeat: no-repeat;
  `
  );
});

    </script>
  </body>
</html>