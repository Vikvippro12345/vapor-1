<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scramjet</title>
    <link rel="icon" href="favicon.webp" />
    <link rel="prefetch" href="/scram/scramjet.worker.js" />
    <link rel="prefetch" href="/scram/scramjet.shared.js" />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&amp;family=Inter+Tight:ital,wght@0,100..900;1,100..900&amp;family=Inter:wght@100..900&amp;display=swap&amp;"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Hind:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Hind:wght@300;400;500;600;700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />
    <style>
      body,
      html,
      #app {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        background-color: #050505;
        overflow: hidden;
      }

      @keyframes fade {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/dreamland"></script>
    <script src="/baremux/index.js"></script>
    <script src="/scram/scramjet.controller.js"></script>
    <script src="config.js"></script>

  <body>
    <div id="app"></div>
    <script>
      const scramjet = new ScramjetController({
  files: {
    wasm: "/scram/scramjet.wasm.wasm",
    worker: "/scram/scramjet.worker.js",
    client: "/scram/scramjet.client.js",
    shared: "/scram/scramjet.shared.js",
    sync: "/scram/scramjet.sync.js",
  },
});

scramjet.init();
navigator.serviceWorker.register("./sw.js");

const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
const flex = css`
  display: flex;
`;
const col = css`
  flex-direction: column;
`;

const store = $store(
  {
    url: "https://",
    wispurl:
      _CONFIG?.wispurl ||
      (location.protocol === "https:" ? "wss" : "ws") +
        "://" +
        location.host +
        "/wisp/",
    bareurl:
      _CONFIG?.bareurl ||
      (location.protocol === "https:" ? "https" : "http") +
        "://" +
        location.host +
        "/bare/",
    proxy: "",
  },
  { ident: "settings", backing: "localstorage", autosave: "auto" }
);
connection.setTransport("/epoxy/index.mjs", [{ wisp: store.wispurl }]);

function Config() {
  this.css = `
    transition: opacity 0.4s ease;
    :modal[open] {
        animation: fade 0.4s ease normal;
    }

    :modal::backdrop {
     backdrop-filter: blur(3px);
    }

    .buttons {
      gap: 0.5em;
    }
    .buttons button {
      border: 1px solid #4c8bf5;
      background-color: #313131;
      border-radius: 0.75em;
      color: #fff;
      padding: 0.45em;
    }
    .input_row input {
      background-color: rgb(18, 18, 18);
      border: 2px solid rgb(49, 49, 49);
      border-radius: 0.75em;
      color: #fff;
      outline: none;
      padding: 0.45em;
    }
    .input_row {
      margin-bottom: 0.5em;
      margin-top: 0.5em;
    }
    .input_row input {
      flex-grow: 1;
    }
    .centered {
      justify-content: center;
      align-items: center;
    }
  `;

  function handleModalClose(modal) {
    modal.style.opacity = 0;
    setTimeout(() => {
      modal.close();
      modal.style.opacity = 1;
    }, 250);
  }

  return html`
      <dialog class="cfg" style="background-color: #121212; color: white; border-radius: 8px;">
        <div style="align-self: end">
          <div class=${[flex, "buttons"]}>
            <button on:click=${() =>
              connection.setTransport("/baremod/index.mjs", [
                store.bareurl,
              ])}>use bare server 3</button>
            <button on:click=${() =>
              connection.setTransport("/libcurl/index.mjs", [
                { wisp: store.wispurl },
              ])}>use libcurl.js</button>
              <button on:click=${() =>
                connection.setTransport("/epoxy/index.mjs", [
                  { wisp: store.wispurl },
                ])}>use epoxy</button>
          </div>
        </div>
        <div class=${[flex, col, "input_row"]}>
          <label for="wisp_url_input">Wisp URL:</label>
          <input id="wisp_url_input" bind:value=${use(
            store.wispurl
          )} spellcheck="false"></input>
        </div>
        <div class=${[flex, col, "input_row"]}>
          <label for="bare_url_input">Bare URL:</label>
          <input id="bare_url_input" bind:value=${use(
            store.bareurl
          )} spellcheck="false"></input>
        </div>
            <div class=${[flex, "buttons", "centered"]}>
              <button on:click=${() =>
                handleModalClose(this.root)}>close</button>
            </div>

      </dialog>
  `;
}

function BrowserApp() {
  this.css = `
    width: 100%;
    height: 100%;
    color: #e0def4;
    display: flex;
    flex-direction: column;
    padding: 0.5em;
    padding-top: 0;
    box-sizing: border-box;

    a {
      color: #e0def4;
    }

    input,
    button {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        sans-serif;
    }
    
    h1 {
      font-family: "Inter Tight", "Inter", system-ui, -apple-system, BlinkMacSystemFont,
      sans-serif;
      margin-bottom: 0;
    }
    
    .iframe-container {
      background-color: #fff;
      border: none;
      border-radius: 0.3em;
      flex: 1;
      width: 100%;
      position: relative;
    }
    
    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 0.3em;
      position: absolute;
      top: 0;
      left: 0;
    }

    input.bar {
      font-family: "Inter";
      padding: 0.1em;
      padding-left: 0.3em;
      border: none;
      outline: none;
      color: #fff;
      height: 1.5em;
      border-radius: 0.3em;
      flex: 1;
      background-color: #121212;
      border: 1px solid #313131;
    }
    
    .input_row > label {
      font-size: 0.7rem;
      color: gray;
    }
    
    p {
      margin: 0;
      margin-top: 0.2em;
    }

    .nav {
      padding-top: 0.3em;
      padding-bottom: 0.3em;
      gap: 0.3em;
    }

    .nav button {
      color: #fff;
      outline: none;
      border: none;
      border-radius: 0.30em;
      background-color: #121212;
      border: 1px solid #313131;
      padding: 0.4em;
    }
    
    .tabs-row {
      padding-bottom: 0.3em;
      gap: 0.2em;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .tabs-row::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      display: flex;
      align-items: center;
      gap: 0.3em;
      padding: 0.2em 0.4em;
      background-color: #121212;
      border: 1px solid #313131;
      border-radius: 0.3em;
      color: #e0def4;
      cursor: pointer;
      min-width: 60px;
      max-width: 120px;
      position: relative;
      font-size: 0.75em;
      height: 28px;
      box-sizing: border-box;
    }
    
    .tab.active {
      background-color: #313131;
      border-color: #4c8bf5;
    }
    
    .tab:hover {
      background-color: #252525;
    }
    
    .tab-icon {
      font-size: 12px;
      flex-shrink: 0;
    }
    
    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 11px;
    }
    
    .tab-close {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      background-color: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
    }
    
    .tab-close:hover {
      background-color: #ff4444;
      color: white;
    }
    
    .add-tab {
      width: 28px;
      height: 28px;
      border-radius: 0.3em;
      background-color: #121212;
      border: 1px solid #313131;
      color: #e0def4;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .add-tab:hover {
      background-color: #252525;
    }
  `;

  // Tab management - use reactive state
  this.tabs = $state([]);
  this.activeTabId = $state(0);
  this.nextTabId = 1;

  const cfg = h(Config);
  document.body.appendChild(cfg);

  // Create initial tab
  this.createTab = (url = "https://") => {
    const tabId = this.nextTabId++;
    const frame = scramjet.createFrame();
    
    const tab = {
      id: tabId,
      url: url,
      title: "New Tab",
      frame: frame
    };

    // Set up frame event listeners
    frame.addEventListener("urlchange", (e) => {
      if (!e.url) return;
      const currentTab = this.tabs.find(t => t.id === tabId);
      if (currentTab) {
        currentTab.url = e.url;
        this.updateTabTitle(tabId, e.url);
        if (tabId === this.activeTabId) {
          this.url = e.url;
        }
      }
    });

    this.tabs.push(tab);
    this.activeTabId = tabId;
    this.url = url;
    
    // Navigate to URL if provided
    if (url && url !== "https://") {
      setTimeout(() => frame.go(url), 100);
    }
    
    return tab;
  };

  this.updateTabTitle = (tabId, url) => {
    const tab = this.tabs.find(t => t.id === tabId);
    if (tab) {
      try {
        const urlObj = new URL(url);
        tab.title = urlObj.hostname || url;
      } catch {
        tab.title = url.length > 15 ? url.substring(0, 15) + "..." : url;
      }
    }
  };

  this.switchTab = (tabId) => {
    this.activeTabId = tabId;
    const activeTab = this.tabs.find(t => t.id === tabId);
    if (activeTab) {
      this.url = activeTab.url;
    }
  };

  this.closeTab = (tabId) => {
    const tabIndex = this.tabs.findIndex(t => t.id === tabId);
    if (tabIndex === -1) return;
    
    // Remove the tab's frame from DOM
    const tab = this.tabs[tabIndex];
    if (tab.frame && tab.frame.frame && tab.frame.frame.parentNode) {
      tab.frame.frame.parentNode.removeChild(tab.frame.frame);
    }
    
    this.tabs.splice(tabIndex, 1);
    
    if (this.tabs.length === 0) {
      this.createTab();
    } else if (this.activeTabId === tabId) {
      // Switch to the previous tab or the first one
      const newActiveIndex = Math.max(0, tabIndex - 1);
      this.activeTabId = this.tabs[newActiveIndex].id;
      this.url = this.tabs[newActiveIndex].url;
    }
  };

  this.getCurrentFrame = () => {
    const activeTab = this.tabs.find(t => t.id === this.activeTabId);
    return activeTab ? activeTab.frame : null;
  };

  // Initialize with first tab
  this.url = $state(store.url);
  this.createTab(store.url);

  const handleSubmit = () => {
    this.url = this.url.trim();
    if (!this.url.startsWith("http")) {
      this.url = "https://" + this.url;
    }
    
    const frame = this.getCurrentFrame();
    if (frame) {
      const activeTab = this.tabs.find(t => t.id === this.activeTabId);
      if (activeTab) {
        activeTab.url = this.url;
      }
      return frame.go(this.url);
    }
  };

  return html`
      <div>
        <!-- Tabs Row -->
        <div class=${[flex, "tabs-row"]}>
          ${this.tabs.map(tab => html`
            <div class=${["tab", tab.id === this.activeTabId ? "active" : ""]} 
                 on:click=${() => this.switchTab(tab.id)}>
              <span class="tab-icon">🌐</span>
              <span class="tab-title">${tab.title}</span>
              <button class="tab-close" on:click=${(e) => {
                e.stopPropagation();
                this.closeTab(tab.id);
              }}>×</button>
            </div>
          `)}
          <button class="add-tab" on:click=${() => this.createTab()}>+</button>
        </div>

        <!-- Navigation Row -->
        <div class=${[flex, "nav"]}>
          <button on:click=${() => cfg.showModal()}>⚙</button>
          <button on:click=${() => {
            const frame = this.getCurrentFrame();
            if (frame) frame.back();
          }}>←</button>
          <button on:click=${() => {
            const frame = this.getCurrentFrame();
            if (frame) frame.forward();
          }}>→</button>
          <button on:click=${() => {
            const frame = this.getCurrentFrame();
            if (frame) frame.reload();
          }}>↻</button>

          <input class="bar" autocomplete="off" autocapitalize="off" autocorrect="off" 
                 bind:value=${use(this.url)} 
                 on:input=${(e) => { this.url = e.target.value; }}
                 on:keyup=${(e) => e.keyCode == 13 && (store.url = this.url) && handleSubmit()}>

          <button on:click=${() => window.open(scramjet.encodeUrl(this.url))}>↗</button>
        </div>

        <!-- Iframe Container -->
        <div class="iframe-container">
          ${this.tabs.map(tab => {
            const frame = tab.frame.frame;
            frame.style.display = tab.id === this.activeTabId ? 'block' : 'none';
            return frame;
          })}
        </div>
      </div>
    `;
}

window.addEventListener("load", async () => {
  const root = document.getElementById("app");
  try {
    root.replaceWith(h(BrowserApp));
  } catch (e) {
    root.replaceWith(document.createTextNode("" + e));
    throw e;
  }
  
  function b64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }
  
  const arraybuffer = await (await fetch("/assets/scramjet.png")).arrayBuffer();
  console.log(
    "%cb",
    `
      background-image: url(data:image/png;base64,${b64(arraybuffer)});
      color: transparent;
      padding-left: 200px;
      padding-bottom: 100px;
      background-size: contain;
      background-position: center center;
      background-repeat: no-repeat;
  `
  );
});

    </script>
  </body>
</html>